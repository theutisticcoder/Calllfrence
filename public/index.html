<!DOCTYPE html>
<html>
<head>
		<meta charset="UTF-8" />
		<title>Callference</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.4/socket.io.js" integrity="sha512-YeeA/Qxn5hYdkukScTCNNOhTrv1C2RubAGButJ1rmgQwZf/HdRaCGl+JAVkqsqaNRaYNHdheiuKKuPf9mDcqKg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>
<body>
	<style>
		video{
			position: relative;
			height: 10vh;
			width: 10vw;			
		}
		#c{
			height: 10vh;
			width: 10vw;
			display: none;
		}
		img{
			height: 10vh;
			width: 10vw;
		}
		#you{
			position: absolute;
			z-index: 4;
			top: 90vh;
			left: 90vw;
			border: 3px solid white;
		}
		#people{
			position: relative;
			height: 15vh;
			width: 10vw;
			background: black;
		}
		p{
			color: white;
			top: 70%;
			z-index: 2;
		}
		h1 {
			background: #7F7FD5;
			background: linear-gradient(to right, blue, green, orange);
			background-clip: text;
			-webkit-background-clip: text;
			-webkit-text-fill-color: transparent;
		}

		#drawing-board {
			border: 1px solid black;
			height: 300px;
			width: 300px;
		}

		.container {
			display: none;
			height: 100%;
			display: flex;
		}

		#toolbar {
			display: flex;
			flex-direction: column;
			padding: 5px;
			width: 70px;
			background-color: #202020;
		}

		#toolbar * {
			margin-bottom: 6px;
		}

		#toolbar label {
			font-size: 12px;
		}

		#toolbar input {
			width: 100%;
		}

		#clear {
			background-color: #1565c0;
			border: none;
			border-radius: 4px;
			color: white;
			padding: 2px;
		}

		#erase {
			background-color: black;
			border: none;
			border-radius: 4px;
			color: white;
			padding: 2px;
		}
		#map{
			rotate: 1 0 0 20deg;
			postion: absolute;
			left: 200px;
			top: 400px;
		}
	</style>
		<div id="you">
				<video id="v" muted="true" autoplay="true"></video>
			<button onclick="muted();">Microphone</button>
			<button onclick="hide();">Camera</button>
		</div>
	<canvas id="c"></canvas>
	<div id="people" hidden></div>
	<section class="container">
		<div id="toolbar">
			<h1>Draw!</h1>
			<label for="stroke">Stroke</label>
			<input id="stroke" name='stroke' type="color">
			<button id="erase">Eraser</button>
			<label for="lineWidth">Brush Width</label>
			<input id="lineWidth" name='lineWidth' type="number" value="5">
			<button id="clear">Clear</button>
			<button id="heightmap">Generate Heightmap</button>
		</div>
		<div id="map"></div>
		<div class="drawing-board">
			<canvas id="drawing-board"></canvas>
		</div>
	</section>
		<script>
			var chunknum = 0;
			var chunks = [];
			var a;
			var audio;
			var mute = false;
			var cam = true;
			function muted()
			{
				if(mute == false) {
					mute = true;
					(async () => {
     a = await navigator.mediaDevices.getUserMedia({audio: true, video: false});
	a = new MediaRecorder(a);
					a.start();
						setTimeout(speak, 10);
				})();
				}
				else mute = false;
			}
			function hide()
			{
				if(cam == false) cam = true;
				else cam = false;
			}
			var people = document.getElementById("people");
						const socket = io();
			var username = prompt("Choose an username.");
			socket.emit("username", username);
			var room = confirm("Join Room? If you click cancel, you will create your own.");
			if(room === true){
				var rjoin = prompt("Enter the room name here.");
				var pjoin = prompt("Enter the password here.");
				socket.emit("roomtest", rjoin);
				socket.emit("passtest", pjoin);
			}
			else{
				var rjoin = prompt("Choose a room name.");
				var pjoin = prompt("Choose a password.");
				socket.emit("roomnew", rjoin);
				socket.emit("passnew", pjoin);
			}
			const canvas = document.getElementById("c");
			var ctx = canvas.getContext("2d");
			var number;
			var vclone, aclone;
			var source;
			socket.on("me", p => {
				number = p;
			})
			var video = document.querySelector("#v");
			
			socket.on("retry",()=> {
				alert("Wrong room name or password, try again.");
				location.reload();
			})
			socket.on("tryagain",()=> {
				alert("Room name or password taken, try again.");
				location.reload();
			})
			socket.on("start", ()=> {
				socket.emit("newperson");
					socket.on("joined", p=> {
						aclone = new Audio();
						aclone.id = p + "1026";
						people = people.cloneNode();
						people.hidden = false;
						aclone.autoplay = true;
				vclone = new Image();
				vclone.id = p;
				people.appendChild(vclone);
				var name = document.createElement("p");
				name.innerHTML = p;
				people.appendChild(name);
						people.appendChild(aclone)
						document.body.appendChild(people)
			});
			if (navigator.mediaDevices.getUserMedia) {
				navigator.mediaDevices.getUserMedia({ video: true, audio: false})
					.then(function (stream) {
						video.srcObject = stream;
					setTimeout(draw, 1000/60);
					})
					.catch(function (error) {
						console.log("Something went wrong!");
					});
			}
			socket.on("v", v=> {
				document.getElementById(v.number).src = v.video;
				setTimeout(draw, 1000/30)
			});
				socket.on("a", v=> {
					document.getElementById(v.user + "1026").src = v.audio;					
				})
				function draw(){
					ctx.drawImage(document.getElementById("v"),0,0, canvas.width, canvas.height);
					if(cam == true) socket.emit("video", canvas.toDataURL("image/png"));
				}
				
				socket.on("left", num=> {
					document.getElementById(num).parentElement.remove();
				})
				});
			function speak(){
					a.stop();
				a.ondataavailable = (e) => {
					if(mute == true) socket.emit("audio",{audio: URL.createObjectURL(e.data), user: username});
					source = URL.createObjectURL(e.data);
				a.start();
				setTimeout(speak, 500);
				}
				}
			function board(){
				const heightmap = document.getElementById("heightmap");
		const canvas = document.getElementById('drawing-board');
		const toolbar = document.getElementById('toolbar');
		const eraser = document.getElementById('erase');
		const ctx = canvas.getContext('2d');
		document.querySelector(".container").style.display = "block";
		const canvasOffsetX = canvas.offsetLeft;
		const canvasOffsetY = canvas.offsetTop;

		canvas.width = "300";
		canvas.height = "300";

		let isPainting = false;
		let lineWidth = 5;
		let startX;
		let startY;

		toolbar.addEventListener('click', e => {
			if (e.target.id === 'clear') {
				ctx.clearRect(0, 0, canvas.width, canvas.height);
			}
		});

		toolbar.addEventListener('change', e => {
			if (e.target.id === 'stroke') {
				ctx.strokeStyle = e.target.value;
			}

			if (e.target.id === 'lineWidth') {
				lineWidth = e.target.value;
			}

		});

		const draw = (e) => {
			if (!isPainting) {
				return;
			}

			ctx.lineWidth = lineWidth;
			ctx.lineCap = 'round';

			ctx.lineTo(e.clientX - canvasOffsetX, e.clientY);
			ctx.stroke();
		}

		canvas.addEventListener('mousedown', (e) => {
			isPainting = true;
			startX = e.clientX;
			startY = e.clientY;
		});

		canvas.addEventListener('mouseup', e => {
			isPainting = false;
			ctx.stroke();
			ctx.beginPath();
			socket.emit("draw", canvas.toDataURL("img/png"))
		});
		function rgbaToHex(r, g, b, a) {
			const rHex = r.toString(16).padStart(2, '0');
			const gHex = g.toString(16).padStart(2, '0');
			const bHex = b.toString(16).padStart(2, '0');
			const aHex = a.toString(16).padStart(2, '0');
			return `#${rHex}${gHex}${bHex}${aHex}`;
		}
		canvas.addEventListener('mousemove', draw);

		toolbar.addEventListener('click', e => {
			if (e.target.id === 'erase') {
				eraser.style.backgroundColor = "#b58691";
				ctx.strokeStyle = 'white';
				e.target.id = "draw";
			}
			if (e.target.id != 'erase' && eraser.style.backgroundColor === '#b58691') {
				eraser.style.backgroundColor = "black";
				e.target.id = "erase"
			}
		});
				socket.on("drawn", (e)=> {
					canvas.drawImage(e, 0, 0, canvas.width, canvas.height);
				})
		function lightness(Rint, Gint, Bint) { // takes sRGB channels as 8 bit integers

			var Rlin = (Rint / 255.0) ** 2.218;   // Convert int to decimal 0-1 and linearize
			var Glin = (Gint / 255.0) ** 2.218;   // ** is the exponentiation operator, older JS needs Math.pow() instead
			var Blin = (Bint / 255.0) ** 2.218;   // 2.218 Gamma for sRGB linearization. 2.218 sets unity with the piecewise sRGB at #777 .... 2.2 or 2.223 could be used instead

			var Ylum = Rlin * 0.2126 + Glin * 0.7156 + Blin * 0.0722;   // convert to Luminance Y

			return Math.pow(Ylum, 0.43) * 100;  // Convert to lightness (0 to 100)
		}
		var pixel, piece;
		heightmap.onclick = () => {
			for (let i = 0; i < canvas.height; i++) {
				for (let x = 0; x < canvas.width; x++) {
					pixel = ctx.getImageData(x, i, x + 1, i + 1).data;
					piece = document.createElement("div");
					piece.style.transform = `perspective(1000px) translateX(${x * 5}px) translateZ(${i * 5}px) translateY(${lightness(pixel[0], pixel[1], pixel[2]) * 5
						})`;
					piece.style.height = "5px";
					piece.style.width = "5px";
					piece.style.backgroundColor = rgbaToHex(pixel[0], pixel[1], pixel[2], pixel[3]);
					document.getElementById("map").appendChild(piece);
				}
			}
		}
		var ypos, xpos;
		document.getElementById("map").ondrag = (e)=>{
			xpos = e.clientX;
			ypos = e.clientY;
			document.getElementById("map").style.transform = "rotateX(" + ypos+ "deg) rotateY(" + xpos+ "deg)";
		};
			}
		</script>
	<button onclick="board()">Draw!</button>

</body>
</html>
