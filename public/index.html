<!DOCTYPE html>
<html>
<head>
		<meta charset="UTF-8" />
		<title>Callference</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.4/socket.io.js" integrity="sha512-YeeA/Qxn5hYdkukScTCNNOhTrv1C2RubAGButJ1rmgQwZf/HdRaCGl+JAVkqsqaNRaYNHdheiuKKuPf9mDcqKg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>
<body>
	<style>
		video{
			position: relative;
			height: 10vh;
			width: 10vw;			
		}
		#c{
			height: 10vh;
			width: 10vw;
			display: none;
		}
		img{
			height: 10vh;
			width: 10vw;
		}
		#you{
			position: absolute;
			z-index: 4;
			top: 90vh;
			left: 90vw;
			border: 3px solid white;
		}
		#people{
			position: relative;
			height: 15vh;
			width: 10vw;
			background: black;
		}
		p{
			color: white;
			top: 70%;
			z-index: 2;
		}
		h1 {
			background: #7F7FD5;
			background: linear-gradient(to right, blue, green, orange);
			background-clip: text;
			-webkit-background-clip: text;
			-webkit-text-fill-color: transparent;
		}

		#drawing-board {
			border: 1px solid black;
			height: 300px;
			width: 300px;
		}

		.container {
			height: 100%;
			display: flex;
		}

		#toolbar {
			display: flex;
			flex-direction: column;
			padding: 5px;
			width: 70px;
			background-color: #202020;
		}

		#toolbar * {
			margin-bottom: 6px;
		}

		#toolbar label {
			font-size: 12px;
		}

		#toolbar input {
			width: 100%;
		}

		#clear {
			background-color: #1565c0;
			border: none;
			border-radius: 4px;
			color: white;
			padding: 2px;
		}

		#erase {
			background-color: black;
			border: none;
			border-radius: 4px;
			color: white;
			padding: 2px;
		}
		#map{
			rotate: 1 0 0 20deg;
			postion: absolute;
			left: 200px;
			top: 400px;
		}
	</style>
		<div id="you">
				<video id="v" muted="true" autoplay="true"></video>
			<button onclick="muted();">Microphone</button>
			<button onclick="hide();">Camera</button>
		</div>
	<canvas id="c"></canvas>
	<div id="people" hidden></div>
	<section class="container">
		<div id="toolbar">
			<h1>Draw!</h1>
			<label for="stroke">Stroke</label>
			<input id="stroke" name='stroke' type="color">
			<button id="erase">Eraser</button>
			<label for="lineWidth">Brush Width</label>
			<input id="lineWidth" name='lineWidth' type="number" value="5">
			<button id="clear">Clear</button>
			<button id="heightmap">Generate Heightmap</button>
		</div>
		<div id="map"></div>
		<div class="drawing-board">
			<canvas id="drawing-board"></canvas>
		</div>
	</section>
		<script>
			const canvas2 = document.getElementById('drawing-board');
		const toolbar = document.getElementById('toolbar');
		const eraser = document.getElementById('erase');
		const ctx2 = canvas2.getContext('2d');
		const canvasOffsetX = canvas2.offsetLeft;
		const canvasOffsetY = canvas2.offsetTop;

		canvas2.width = "300";
		canvas2.height = "300";

		let isPainting = false;
		let lineWidth = 5;
		let startX;
		let startY;
			var chunknum = 0;
			var chunks = [];
			var a;
			var audio;
			var mute = false;
			var cam = true;
			function muted()
			{
				if(mute == false) {
					mute = true;
					(async () => {
     a = await navigator.mediaDevices.getUserMedia({audio: true, video: false});
	a = new MediaRecorder(a);
					a.start();
						setTimeout(speak, 10);
				})();
				}
				else mute = false;
			}
			function hide()
			{
				if(cam == false) cam = true;
				else cam = false;
			}
			var people = document.getElementById("people");
						const socket = io();
			var username = prompt("Choose an username.");
			socket.emit("username", username);
			var room = confirm("Join Room? If you click cancel, you will create your own.");
			if(room === true){
				var rjoin = prompt("Enter the room name here.");
				var pjoin = prompt("Enter the password here.");
				socket.emit("roomtest", rjoin);
				socket.emit("passtest", pjoin);
			}
			else{
				var rjoin = prompt("Choose a room name.");
				var pjoin = prompt("Choose a password.");
				socket.emit("roomnew", rjoin);
				socket.emit("passnew", pjoin);
			}
			const canvas = document.getElementById("c");
			var ctx = canvas.getContext("2d");
			var number;
			var vclone, aclone;
			var source;
			socket.on("me", p => {
				number = p;
			})
			var video = document.querySelector("#v");
			
			socket.on("retry",()=> {
				alert("Wrong room name or password, try again.");
				location.reload();
			})
			socket.on("tryagain",()=> {
				alert("Room name or password taken, try again.");
				location.reload();
			})
			socket.on("start", ()=> {
				socket.emit("newperson");
					socket.on("joined", p=> {
						aclone = new Audio();
						aclone.id = p + "1026";
						people = people.cloneNode();
						people.hidden = false;
						aclone.autoplay = true;
				vclone = new Image();
				vclone.id = p;
				people.appendChild(vclone);
				var name = document.createElement("p");
				name.innerHTML = p;
				people.appendChild(name);
						people.appendChild(aclone)
						document.body.appendChild(people)
			});
			if (navigator.mediaDevices.getUserMedia) {
				navigator.mediaDevices.getUserMedia({ video: true, audio: false})
					.then(function (stream) {
						video.srcObject = stream;
					setTimeout(draw, 1000/60);
					})
					.catch(function (error) {
						console.log("Something went wrong!");
					});
			}
			socket.on("v", v=> {
				document.getElementById(v.number).src = v.video;
				setTimeout(draw, 1000/30)
			});
				socket.on("a", v=> {
					document.getElementById(v.user + "1026").src = v.audio;					
				})
				function draw(){
					ctx.drawImage(document.getElementById("v"),0,0, canvas.width, canvas.height);
					if(cam == true) socket.emit("video", canvas.toDataURL("image/jpeg"));
				}
				
				socket.on("left", num=> {
					document.getElementById(num).parentElement.remove();
				})
				});
			function speak(){
					a.stop();
				a.ondataavailable = (e) => {
					if(mute == true) socket.emit("audio",{audio: URL.createObjectURL(e.data), user: username});
					source = URL.createObjectURL(e.data);
				a.start();
				setTimeout(speak, 500);
				}
				}
			function board(){
		

		toolbar.addEventListener('click', e => {
			if (e.target.id === 'clear') {
				ctx2.clearRect(0, 0, canvas2.width, canvas2.height);
			}
		});

		toolbar.addEventListener('change', e => {
			if (e.target.id === 'stroke') {
				ctx2.strokeStyle = e.target.value;
			}

			if (e.target.id === 'lineWidth') {
				lineWidth = e.target.value;
			}

		});

		const draw = (e) => {
			

			ctx2.lineWidth = lineWidth;
			ctx2.lineCap = 'round';

			ctx2.lineTo(e.clientX - canvasOffsetX, e.clientY);
			ctx2.stroke();
		}

		canvas2.addEventListener('dragstart', (e) => {
			startX = e.clientX;
			startY = e.clientY;
		});

		canvas2.addEventListener('dragend', e => {
			ctx2.stroke();
			ctx2.beginPath();
			socket.emit("draw", canvas2.toDataURL("image/png"));
		});
		canvas2.addEventListener('drag', draw);

		toolbar.addEventListener('click', e => {
			if (e.target.id === 'erase') {
				eraser.style.backgroundColor = "#b58691";
				ctx2.strokeStyle = 'white';
				e.target.id = "draw";
			}
			if (e.target.id != 'erase' && eraser.style.backgroundColor === '#b58691') {
				eraser.style.backgroundColor = "black";
				e.target.id = "erase"
			}
		});
				socket.on("drawn", (e)=> {
					ctx2.drawImage(e, 0, 0, canvas2.width, canvas2.height);
				});
		var ypos, xpos;
			}
		</script>
	<button onclick="board()">Draw!</button>

</body>
</html>
