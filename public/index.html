<!DOCTYPE html>
<html>
<head>
		<meta charset="UTF-8" />
		<title>Callference</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.4/socket.io.js" integrity="sha512-YeeA/Qxn5hYdkukScTCNNOhTrv1C2RubAGButJ1rmgQwZf/HdRaCGl+JAVkqsqaNRaYNHdheiuKKuPf9mDcqKg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>
<body>
	<style>
		video{
			position: relative;
			height: 10vh;
			width: 10vw;			
		}
		#c{
			height: 10vh;
			width: 10vw;
			display: none;
		}
		img{
			height: 10vh;
			width: 10vw;
		}
		#you{
			position: absolute;
			z-index: 4;
			top: 90vh;
			left: 90vw;
			border: 3px solid white;
		}
		#people{
			position: relative;
			height: 15vh;
			width: 10vw;
			background: black;
		}
		p{
			color: white;
			top: 70%;
			z-index: 2;
		}
	</style>
		<div id="you">
				<video id="v" muted="true" autoplay="true"></video>
			<button onclick="muted();">Microphone</button>
			<button onclick="hide();">Camera</button>
		</div>
	<canvas id="c"></canvas>
	<div id="people" hidden></div>
		<script>
			var chunknum = 0;
			var chunks = [];
			var a;
			var audio;
			var mute = false;
			var cam = true;
			function muted()
			{
				if(mute == false) mute = true;
				else mute = false;
			}
			function hide()
			{
				if(cam == false) cam = true;
				else cam = false;
			}
			var people = document.getElementById("people");
						const socket = io();
			var username = prompt("Choose an username.");
			socket.emit("username", username);
			var room = confirm("Join Room? If you click cancel, you will create your own.");
			if(room === true){
				var rjoin = prompt("Enter the room name here.");
				var pjoin = prompt("Enter the password here.");
				socket.emit("roomtest", rjoin);
				socket.emit("passtest", pjoin);
			}
			else{
				var rjoin = prompt("Choose a room name.");
				var pjoin = prompt("Choose a password.");
				socket.emit("roomnew", rjoin);
				socket.emit("passnew", pjoin);
			}
			const canvas = document.getElementById("c");
			var ctx = canvas.getContext("2d");
			var number;
			var vclone, aclone;
			var source;
			socket.on("me", p => {
				number = p;
			})
			var video = document.querySelector("#v");
			
			socket.on("retry",()=> {
				alert("Wrong room name or password, try again.");
				location.reload();
			})
			socket.on("tryagain",()=> {
				alert("Room name or password taken, try again.");
				location.reload();
			})
			socket.on("start", ()=> {
				socket.emit("newperson");
					socket.on("joined", p=> {
						aclone = new Audio();
						aclone.id = p + "1026";
						people = people.cloneNode();
						people.hidden = false;
						aclone.autoplay = true;
				vclone = new Image();
				vclone.id = p;
				people.appendChild(vclone);
				var name = document.createElement("p");
				name.innerHTML = p;
				people.appendChild(name);
						people.appendChild(aclone)
						document.body.appendChild(people)
			});
			if (navigator.mediaDevices.getUserMedia) {
				navigator.mediaDevices.getUserMedia({ video: true, audio: false})
					.then(function (stream) {
						video.srcObject = stream;
					setTimeout(draw, 1000/60);
					})
					.catch(function (error) {
						console.log("Something went wrong!");
					});
				(async () => {
     a = await navigator.mediaDevices.getUserMedia({audio: true, video: false});
	a = new MediaRecorder(a);
					a.start(500);
					a.ondataavailable = (e)=> {
					chunks.push(e.data);	
					chunknum++;
						a.stop();
					};
				})();
				a.onstop = speak;
			}
			socket.on("v", v=> {
				document.getElementById(v.number).src = v.video;
				setTimeout(draw, 1000/30)
			});
				socket.on("a", v=> {
					document.getElementById(v.user + "1026").src = window.URL.createObjectURL(v.audio);
					source = v.audio;
					
				})
				function draw(){
					ctx.drawImage(document.getElementById("v"),0,0, canvas.width, canvas.height);
					if(cam == true) socket.emit("video", canvas.toDataURL("image/png"));
				}
				function speak(){
					if(mute == true) socket.emit("audio",{audio: chunks[0], user: username});
					a.start();
				}
				socket.on("left", num=> {
					document.getElementById(num).parentElement.remove();
				})
				});
		</script>
</body>
</html>
